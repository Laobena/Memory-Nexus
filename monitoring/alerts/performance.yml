groups:
  - name: performance_alerts
    interval: 30s
    rules:
      # Latency Alerts
      - alert: HighP99Latency
        expr: |
          histogram_quantile(0.99, 
            rate(memory_nexus_pipeline_request_duration_seconds_bucket[5m])
          ) > 0.020
        for: 5m
        labels:
          severity: critical
          component: pipeline
        annotations:
          summary: "P99 latency exceeds 20ms target"
          description: "P99 latency is {{ $value }}s (target: <20ms)"
          
      - alert: HighP95Latency
        expr: |
          histogram_quantile(0.95, 
            rate(memory_nexus_pipeline_request_duration_seconds_bucket[5m])
          ) > 0.015
        for: 10m
        labels:
          severity: warning
          component: pipeline
        annotations:
          summary: "P95 latency exceeds 15ms"
          description: "P95 latency is {{ $value }}s"

      # Cache Performance
      - alert: LowCacheHitRate
        expr: |
          rate(memory_nexus_cache_hits_total[5m]) / 
          (rate(memory_nexus_cache_hits_total[5m]) + rate(memory_nexus_cache_misses_total[5m])) 
          < 0.70
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Cache hit rate below 70%"
          description: "Cache hit rate is {{ $value | humanizePercentage }}"
          
      - alert: CacheEvictionHigh
        expr: rate(memory_nexus_cache_evictions_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "High cache eviction rate"
          description: "Evicting {{ $value }} items/sec"

      # SIMD Operations
      - alert: SIMDNotUtilized
        expr: |
          rate(memory_nexus_simd_operations_total[5m]) == 0 AND
          rate(memory_nexus_scalar_operations_total[5m]) > 0
        for: 15m
        labels:
          severity: warning
          component: simd
        annotations:
          summary: "SIMD operations not being used"
          description: "Falling back to scalar operations, check CPU features"
          
      - alert: SIMDPerformanceDegradation
        expr: |
          rate(memory_nexus_simd_duration_seconds_sum[5m]) /
          rate(memory_nexus_simd_operations_total[5m]) > 0.0001
        for: 10m
        labels:
          severity: warning
          component: simd
        annotations:
          summary: "SIMD operations slower than expected"
          description: "Average SIMD operation taking {{ $value }}s"

      # Router Performance
      - alert: RouterDecisionSlow
        expr: |
          histogram_quantile(0.99,
            rate(memory_nexus_router_decision_duration_seconds_bucket[5m])
          ) > 0.0002
        for: 5m
        labels:
          severity: warning
          component: router
        annotations:
          summary: "Router decision time exceeds 200Î¼s"
          description: "P99 routing decision time is {{ $value | humanizeDuration }}"
          
      - alert: RouterCacheMisrouting
        expr: |
          rate(memory_nexus_router_cache_false_positives_total[5m]) /
          rate(memory_nexus_router_cache_predictions_total[5m]) > 0.05
        for: 10m
        labels:
          severity: warning
          component: router
        annotations:
          summary: "High cache prediction error rate"
          description: "{{ $value | humanizePercentage }} of cache predictions are wrong"

      # Database Connection Pool
      - alert: ConnectionPoolExhausted
        expr: memory_nexus_pool_available_connections == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection pool exhausted"
          description: "No available connections in pool"
          
      - alert: CircuitBreakerOpen
        expr: memory_nexus_circuit_breaker_open == 1
        for: 30s
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Circuit breaker is open"
          description: "Database circuit breaker has tripped"
          
      - alert: HighConnectionWaitTime
        expr: |
          histogram_quantile(0.95,
            rate(memory_nexus_pool_wait_duration_seconds_bucket[5m])
          ) > 0.100
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High database connection wait time"
          description: "P95 wait time is {{ $value | humanizeDuration }}"

      # Memory Pressure
      - alert: HighMemoryUsage
        expr: |
          process_resident_memory_bytes / 
          node_memory_MemTotal_bytes > 0.80
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "Process using >80% of system memory"
          description: "Memory usage at {{ $value | humanizePercentage }}"
          
      - alert: MemoryLeakSuspected
        expr: |
          rate(process_resident_memory_bytes[1h]) > 0 AND
          deriv(process_resident_memory_bytes[1h]) > 0
        for: 30m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "Possible memory leak detected"
          description: "Memory growing at {{ $value | humanize }}/sec"

      # Throughput Alerts
      - alert: LowThroughput
        expr: rate(memory_nexus_requests_total[5m]) < 100
        for: 15m
        labels:
          severity: info
          component: pipeline
        annotations:
          summary: "Low request throughput"
          description: "Processing only {{ $value }} requests/sec"
          
      - alert: ThroughputDrop
        expr: |
          (rate(memory_nexus_requests_total[5m]) - 
           rate(memory_nexus_requests_total[5m] offset 1h)) /
          rate(memory_nexus_requests_total[5m] offset 1h) < -0.50
        for: 10m
        labels:
          severity: warning
          component: pipeline
        annotations:
          summary: "Throughput dropped by >50%"
          description: "Throughput decreased by {{ $value | humanizePercentage }}"

      # Error Rate Alerts
      - alert: HighErrorRate
        expr: |
          rate(memory_nexus_errors_total[5m]) /
          rate(memory_nexus_requests_total[5m]) > 0.01
        for: 5m
        labels:
          severity: critical
          component: pipeline
        annotations:
          summary: "Error rate above 1%"
          description: "Error rate is {{ $value | humanizePercentage }}"
          
      # CPU Optimization Alerts
      - alert: CPUFeaturesMissing
        expr: memory_nexus_cpu_features{feature="avx2"} == 0
        for: 1h
        labels:
          severity: info
          component: system
        annotations:
          summary: "AVX2 not available"
          description: "Running without AVX2 SIMD optimizations"
          
      - alert: SuboptimalBuild
        expr: memory_nexus_build_optimized == 0
        for: 1h
        labels:
          severity: info
          component: system
        annotations:
          summary: "Running non-optimized build"
          description: "Consider using release build with native CPU targeting"